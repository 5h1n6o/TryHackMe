# Threat and Vulnerability Management 

## Nessus

脆弱性スキャナー

- [Nessus](https://www.tenable.com/products/nessus)

## MITRE

### MITREの紹介

アメリカの非営利団体。政府が資金提供する研究開発センターを管理し、航空、防衛、ヘルスケア、国土安全保障、サイバーセキュリティなどの分野で研究を行っている。

サイバーセキュリティのために作成したプロジェクト/研究として以下がある。

- [ATT&CK(Adversarial Tactics,Techniques,and Common Knowledge)](https://attack.mitre.org/)
- [CAR(Cyber Analytics Repository) Knowledge Base](https://car.mitre.org/)
- [ENGAGE](https://engage.mitre.org/)
- [D3FEND(Detection,Denial,and Disruption Framework Empowering Network Defense)](https://d3fend.mitre.org/)
- [AEP(ATT&CK Emulation Plan)](http://attack.mitre.org/resources/adversary-emulation-plans/)

### ATT&CK

脆弱性を悪用した攻撃を戦術とテクニックの観点で分類したナレッジベースであり、サイバー攻撃の流れと手法を体系化したフレームワーク。

- [ATT&CK Navigator](https://mitre-attack.github.io/attack-navigator/)

### CAR

ATT&CKに基づいてMITREによって開発された分析のナレッジベース。  
ATT&CKのMitigation（緩和策）とDetection（検出）よりもさらに踏み込んだ分析を見つけるための追加リソース。

- [分析リスト](https://car.mitre.org/analytics)
- [CAR ATT&CK Navigator](https://mitre-attack.github.io/attack-navigator/#layerURL%3Dhttps%3A%2F%2Fraw.githubusercontent.com%2Fmitre-attack%2Fcar%2Fmaster%2Fdocs%2Fcoverage%2Fcar_analytic_coverage_04_05_2022.json)
  
### ENGAGE

#### MITRE Engageとは

MITRE Engageのホームページには、以下の説明がある。

>MITRE Engage is a framework  
for planning and discussing adversary engagement operations  
that empowers you to engage your adversaries  
and achieve your cybersecurity goals

直訳
>MITER Engageはフレームワークです。  
>攻撃者のエンゲージメント作戦を計画・議論するための。  
>(フレームワークは)敵に立ち向かう力を与えてくれる。  
>そしてサイバーセキュリティの目標を達成する。

2行目の意味が分かりにくい。

#### adversary engagementとは

敵のサイバーオペレーションのコストを上げ、価値を下げるために、Cyber DenialとCyber Deceptionを組み合わせること。

#### Cyber DenialとCyber Deceptionとは

- Cyber Denialは攻撃者の作戦実行を阻止すること。
- Cyber Deceptionは攻撃者を欺くために意図的にアーティファクトを仕掛けること。

#### リソース
- [スタートキット](https://engage.mitre.org/starter-kit/)
- [Engage Matrix Explorer](https://engage.mitre.org/matrix/)

### D3FEND

サイバーセキュリティ対策のナレッジグラフ。  
ATT&CKに相対する関係となっており、攻撃の防御策をナレッジグラフという形で分類している。

- [D3FEND](https://d3fend.mitre.org/)

### ATT&CK Emulation Plans

#### CUID

サイバー脅威とそのTTPに関する調査を実施し、その調査を共有してサイバー防御を改善することを目的とした組織。  

[Center of Threat-Informed Defense](https://mitre-engenuity.org/ctid/)

#### Adversary Emulation Library & ATT&CK Emulations Plans

攻撃者エミュレーションプランをブルー/レッドチーム向けに無料でリリースする公共ライブラリ。

- [エミュレーションプランの紹介](https://medium.com/mitre-engenuity/introducing-the-all-new-adversary-emulation-plan-library-234b1d543f6b)
- [エミュレーションライブラリ](https://github.com/center-for-threat-informed-defense/adversary_emulation_library)

## Yara

Yaraはマルウェア解析に使われる。マルウェアの説明 (Yara ルール) を作成し、ファイルまたはプロセスをスキャンしてそれらが一致するかどうかを確認できるプログラム。

### Task5 Introduction to Yara Rules

#### Yaraの使用方法

yaraコマンドを起動するには2つの引数が必要。

1. 作成するルールファイル
2. そのルールを使用するファイル名、ディレクトリ名またはプロセスID

```shell
# 例）"somedirectory"というディレクトリで "myrule.yar"というルールを使用する場合
$ yara myrule.yar somedirectory
```

#### Yaraルールファイルの形式

- 拡張子は .yar
- ルール名と条件（condition）を記載
  
```shell
# ルールファイルを作成
$ vim examplerule.yar
examplerule {
    condition: true  # 指定したファイル/ディレクトリ/PIDが存在するか
}

$ yara examplerule.yar testfile.txt  # testfile.txtが存在するか確認
examplerule testfile.txt        # testfile.txtが存在していた場合
error scanning textfile.txt: could not open file #存在していなかった場合
```

### Task6 Expanding on Yara Rules

Yaraルールの条件について、[ここ](https://yara.readthedocs.io/en/stable/writingrules.html) を参照。

ルールの条件部分に指定できる主なものについて以下に記載。
| 条件 |　説明     |
| --- | --- |
| meta | ルールに関するメタ情報を記述できるセクション。    |
| strings    | 検索したいワードを記述するセクション。    |
| condition  | "true" や "any of them"、演算子(<=,>=,!=など)を使って条件を記述するセクション。条件は and で組み合わせることができる。    |

[チートシート](https://medium.com/malware-buddy/security-infographics-9c4d3bd891ef#18dd)


### Task7 Yara Modules

- [Cuckoo](https://cuckoosandbox.org/)
- [PythonのPEモジュール](https://pypi.org/project/pefile/)

### Task8 Other tools and Yara

#### リソース
- [awesome-yara](https://github.com/InQuest/awesome-yara) Yaraリポジトリへのリンク集
- [LOKI](https://github.com/Neo23x0/Loki) オープンソースのIOC（Indicator of Compromise）スキャナー
- [THOR Lite](https://www.nextron-systems.com/thor-lite/) IOCおよびYARAスキャナー
- [FENRIR](https://github.com/Neo23x0/Fenrir) シンプルな Bash製 IOC スキャナー
- [YAYA](https://github.com/EFForg/yaya) Yaraルールの管理とスキャンの実行に役立つツール

### Task9 Using LOKI and its Yara rule set

#### LOKIとは

シンプルなIOCスキャナーで検出は次の4つの方法に基づいている。

1. File Name IOC  
2. Yara Rule Check
3. Hash Check
4. C2 Back Connect Check

#### LOKIの実行

システムでLokiを最初に実行するときは --updateを実行。signature-baseディレクトリが更新される。

```shell
$ python loki.py --update
$ cd signature-base
$ ls 
iocs misc yara     # yaraディレクトリにyaraルールファイルがある
```

Lokiを実行するには、対象ファイルのあるディレクトリがカレントディレクトリとなっている状態で以下のコマンドを実行する。

```shell
python ~/tools/Loki/loki.py -p .
```

#### タスク9の質問と解答

1. file1ディレクトリへ移動後 lokiを実行し結果を確認する。
2. 1の結果で確認できる。
3. 1の結果で確認できる。
4. 1の結果で確認できる。
5. 1の結果で確認できる。
6. yaraディレクトリにある thor-webshel​​ls.yarのルール名 webshell_metaslsoft を調べる。
7. file2ディレクトリへ移動後、lokiを実行し結果を確認する。
8. 1ndex.phpをlessで開き確認する。indexではなく1ndex（iの部分が数字の1になっているので注意）

### Task10 Creating Yara rules with yarGen

#### yarGenとは

[yarGen](https://github.com/Neo23x0/yarGen) YARAルールのジェネレーター

#### yarGenの実行

システムでyarGenを最初に実行するときは --updateを実行。

```shell
$ python yarGen.py --update
```

対象のファイルに対するのYaraルールを生成するには以下のコマンドを実行。

```shell
$ python3 yarGen.py -m 対象ファイルのパス --excludegood -o 出力ファイル名
　　# --excludegoodは正規の文字列を強制的に除外するオプション
```

#### yaraルールの生成とyarGenの使用に関する情報

- [yarAnalyzer](https://github.com/Neo23x0/yarAnalyzer/) yarGenとは別のyaraルール生成ツール
- https://www.bsk-consulting.de/2015/02/16/write-simple-sound-yara-rules/
- https://www.bsk-consulting.de/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/
- https://www.bsk-consulting.de/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/

#### タスク10の質問と解答

以下のとおり確認。

```shell
# yarGenでルール作成
$ cd ~/tools/yarGen
python3 yarGen.py -m /home/cmnatic/suspicious-files/file2 --excludegood -o /home/cmnatic/suspicious-files/file2.yar
# 作成したファイル file2.yarを ~/tools/Loki/signature-base/yara配下にコピー
cp ~/suspicious-files/file2.yar ~/tools/Loki/signature-base/yara

# Lokiを実行
$ cd ~/suspicious-files/file2
$ python ~/tools/Loki/loki.py -p .
```

1. yaraコマンドを使用する。ルール名はfile2.yar。
2. Yay
3. 解LokiLoki
4. Yay
5. 上記のLokiコマンドを実行した結果で確認できる。
6. file2.yar内で stringsを検索すると分かる。
   
### Valhalla

[Valhallaのサーチ画面](https://valhalla.nextron-systems.com/)

#### タスク11の質問と解答

1. sha256sum コマンドでfile1のハッシュ値を調べてValhallaで検索。
2. 1と同じ手順でValhallaで検索すると分かる。
3. 2の検索結果画面で最初のルール名の行の右端にVT列のマークをクリックし確認する。
4. VirusTatalでfile2のハッシュ値を検索
5. 4の結果画面の「DETAILS」メニューを表示し、「Names」欄を確認。.php以外の拡張子を持つファイル情報が確認できる。
6. 2のValhallaの検索結果画面で「Ref」列のマークからGitHubのページへ行き、index.phpの内容を見れば分かる。
7. 2の検索結果からタイプはwebshellに関するルールと思われる。~/tools/Loki/signature-base/yaraの中で ファイル名にwebshellを含むファイルを対象に、"Webshell_b374k_rule1"ルールが含まれていないか確認。

## Zero Logon

### Task1 The Zero Day Angle

説明文をよんだが、よく理解できなかったが、以下のNRIセキュアブログを読んでなんとなく理解。  
[Zerologon（ゼロログオン）とは？脆弱性の仕組みとその対策を解説](https://www.nri-secure.co.jp/blog/looking-back-on-the-vulnerability-zerologon)

### Task2 Impacket Installation

スキップ

### Task3 Task Proof of Concept

#### タスク3の質問と解答

1. タスク1の図3の最終ステップの部分を見れば分かる。
2. [NetrServerPasswordSet2](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/14b020a8-0bcf-4af5-ab72-cc92bc6b1d81)で確認。
3. 2と同じページで確認。
4. 解答不要。



## OpenVAS

## MISP
